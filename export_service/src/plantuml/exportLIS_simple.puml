@startuml
'https://plantuml.com/sequence-diagram

autonumber

participant "interceptor (VM in DMZ)" as icp
participant "integration service" as int
participant "lab-order service" as lab
participant "patient service" as pat

group cron job [every 20 seconds]
icp -> int: getLabOrdersToExport
activate icp
activate int
int -> lab: getLabOrdersWithStateReady
activate lab
lab -> lab: get all lab orders with state <b>SAMPLES_REGISTERED</b>
lab --> int: lab orders
deactivate lab
deactivate icp

end

loop for each lab order


int -> lab: getLabOrderById
activate lab
lab --> int: lab order (Dto)
deactivate lab
int -> pat: getPatientById
activate pat
pat --> int: patientAndCoverages (Dto)
deactivate pat

int -> int: Convert DLO to HL7 ORM (patient, coverages, labOrder)
int -> int: store HL7 ORM \nmessage to SFTP server Folder by Client

int -> lab: confirmLabOrderExported
activate lab
lab -> lab: set status <b>ACCEPTED</b>
lab --> int
deactivate lab

deactivate int

end

activate icp
icp->icp: loadFiles_sFTP
deactivate icp




@enduml
